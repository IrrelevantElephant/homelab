name: Pipeline

on:
  push:
    branches: ["main"]

jobs:
  tag:
    name: "Tag repo"
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Conventional Changelog Action
        id: conventional_changelog
        uses: TriPSs/conventional-changelog-action@v6
        with:
          preset: conventionalcommits
          github-token: ${{ secrets.github_token }}
          skip-commit: true
    outputs:
      version: ${{ steps.conventional_changelog.outputs.version }}

  argocd:
    name: "List out of sync apps"
    runs-on: ubuntu-24.04
    outputs:
      apps_to_sync: ${{ steps.list_apps.outputs.apps_to_sync }}
    steps:
      - name: "login"
        uses: clowdhaus/argo-cd-action/@main
        with:
          version: 2.12.4
          command: login
          options:  --grpc-web --password ${{ secrets.ARGOPASSWORD }} --username admin argocd.giulia-harry.dev
      - name: "list apps"
        id: list_apps
        shell: bash
        run: |
          APPSTOSYNC=$(argocd app list --grpc-web -o=json | jq -c '{include: [.[] | select(.status.sync.status != "Synced") | {app: .metadata.name }]}')
          echo $APPSTOSYNC | jq
          echo "apps_to_sync=$APPSTOSYNC" >> "$GITHUB_OUTPUT"
  
  sync-apps:
      name: "Sync Argo apps"
      runs-on: ubuntu-24.04
      needs: argocd
      strategy:
        matrix: ${{fromJson(needs.argocd.outputs.apps_to_sync)}}
      steps:
        - name: "login"
          uses: clowdhaus/argo-cd-action/@main
          with:
            version: 2.12.4
            command: login
            options:  --grpc-web --password ${{ secrets.ARGOPASSWORD }} --username admin argocd.giulia-harry.dev
        - name: "sync"
          shell: bash
          run: |
            argocd app sync ${{matrix.app}} --grpc-web
